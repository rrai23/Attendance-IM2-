<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete System Data Consistency Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2, h3 { color: #333; }
        .test-section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        .info { color: blue; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
        .module-name { font-weight: bold; color: #333; }
        .count { font-size: 18px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Complete System Data Consistency Verification</h1>
    <p>This test verifies that ALL system components are using the same employee data and attendance records.</p>

    <div class="test-section">
        <h2>Employee Count Summary</h2>
        <div id="count-summary"></div>
    </div>

    <div class="test-section">
        <h2>Module-by-Module Verification</h2>
        <div id="module-verification"></div>
    </div>

    <div class="test-section">
        <h2>Employee Details Comparison</h2>
        <table id="employee-details">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Department</th>
                    <th>Position</th>
                    <th>Role</th>
                    <th>Status in All Modules</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="test-section">
        <h2>Today's Attendance Coverage</h2>
        <div id="attendance-coverage"></div>
        <table id="attendance-today">
            <thead>
                <tr>
                    <th>Employee ID</th>
                    <th>Name</th>
                    <th>Time In</th>
                    <th>Status</th>
                    <th>In Records</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="test-section">
        <h2>Final Verdict</h2>
        <div id="final-verdict"></div>
    </div>

    <script src="js/mock-data.js"></script>
    <script src="js/data-service.js"></script>
    <script src="js/employee-attendance.js"></script>
    <script src="js/data-manager.js"></script>
    <script>
        let modules = {};

        async function runCompleteTest() {
            try {
                // Initialize all modules
                modules.dataService = new DataService();
                modules.attendanceManager = new EmployeeAttendanceManager();
                modules.dataManager = new DataManager();

                await modules.attendanceManager.init();
                await modules.dataManager.init();

                await testEmployeeCounts();
                await testModuleVerification();
                await testEmployeeDetails();
                await testAttendanceCoverage();
                generateFinalVerdict();

            } catch (error) {
                console.error('Complete test failed:', error);
                document.getElementById('final-verdict').innerHTML = `<p class="error">❌ Test failed: ${error.message}</p>`;
            }
        }

        async function testEmployeeCounts() {
            const output = document.getElementById('count-summary');
            let html = '<h3>Employee Counts by Module:</h3>';

            try {
                const counts = {
                    mockData: mockData.users?.length || 0,
                    dataService: (await modules.dataService.getEmployees()).length,
                    attendanceManager: modules.attendanceManager.employees.length,
                    dataManager: modules.dataManager.employees.length
                };

                const allMatch = Object.values(counts).every(count => count === 6);
                const statusClass = allMatch ? 'success' : 'error';
                const statusIcon = allMatch ? '✅' : '❌';

                html += '<table>';
                html += '<tr><th>Module</th><th>Employee Count</th></tr>';
                Object.entries(counts).forEach(([module, count]) => {
                    const countClass = count === 6 ? 'success' : 'error';
                    html += `<tr><td class="module-name">${module}</td><td class="count ${countClass}">${count}</td></tr>`;
                });
                html += '</table>';

                html += `<p class="${statusClass}">${statusIcon} All modules ${allMatch ? 'MATCH' : 'DO NOT MATCH'} with expected count of 6</p>`;

                output.innerHTML = html;

            } catch (error) {
                output.innerHTML = `<p class="error">❌ Error testing employee counts: ${error.message}</p>`;
            }
        }

        async function testModuleVerification() {
            const output = document.getElementById('module-verification');
            let html = '<h3>Module Data Source Verification:</h3>';

            try {
                const dataServiceEmployees = await modules.dataService.getEmployees();
                
                // Test each module's data against data service
                const tests = [
                    {
                        name: 'Employee Attendance Manager',
                        employees: modules.attendanceManager.employees,
                        test: (empList) => empList.length === 6 && empList.every(emp => 
                            dataServiceEmployees.some(dsEmp => dsEmp.id === emp.id)
                        )
                    },
                    {
                        name: 'Data Manager',
                        employees: modules.dataManager.employees,
                        test: (empList) => empList.length === 6 && empList.every(emp => 
                            dataServiceEmployees.some(dsEmp => dsEmp.id === emp.id)
                        )
                    }
                ];

                html += '<table>';
                html += '<tr><th>Module</th><th>Using Data Service</th><th>Data Consistent</th></tr>';
                
                tests.forEach(test => {
                    const isConsistent = test.test(test.employees);
                    const icon = isConsistent ? '✅' : '❌';
                    const statusClass = isConsistent ? 'success' : 'error';
                    
                    html += `<tr>
                        <td class="module-name">${test.name}</td>
                        <td class="${statusClass}">${icon}</td>
                        <td class="${statusClass}">${isConsistent ? 'Yes' : 'No'}</td>
                    </tr>`;
                });

                html += '</table>';
                output.innerHTML = html;

            } catch (error) {
                output.innerHTML = `<p class="error">❌ Error verifying modules: ${error.message}</p>`;
            }
        }

        async function testEmployeeDetails() {
            const tableBody = document.querySelector('#employee-details tbody');

            try {
                const dataServiceEmployees = await modules.dataService.getEmployees();
                
                tableBody.innerHTML = '';
                dataServiceEmployees.forEach(emp => {
                    const attEmp = modules.attendanceManager.employees.find(e => e.id === emp.id);
                    const dmEmp = modules.dataManager.employees.find(e => e.id === emp.id);
                    
                    const inAllModules = attEmp && dmEmp;
                    const statusIcon = inAllModules ? '✅ All' : '❌ Missing';
                    const statusClass = inAllModules ? 'success' : 'error';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${emp.id}</td>
                        <td>${emp.firstName} ${emp.lastName}</td>
                        <td>${emp.department}</td>
                        <td>${emp.position}</td>
                        <td>${emp.role}</td>
                        <td class="${statusClass}">${statusIcon}</td>
                    `;
                    tableBody.appendChild(row);
                });

            } catch (error) {
                console.error('Error testing employee details:', error);
            }
        }

        async function testAttendanceCoverage() {
            const output = document.getElementById('attendance-coverage');
            const tableBody = document.querySelector('#attendance-today tbody');

            try {
                const dataServiceEmployees = await modules.dataService.getEmployees();
                const attendanceRecords = modules.attendanceManager.attendanceRecords;
                const today = '2025-07-12';
                const todayRecords = attendanceRecords.filter(record => record.date === today);

                const hasRecordForAll = dataServiceEmployees.every(emp => 
                    todayRecords.some(record => record.employeeId === emp.id)
                );

                const statusIcon = hasRecordForAll ? '✅' : '❌';
                const statusClass = hasRecordForAll ? 'success' : 'error';

                output.innerHTML = `
                    <p class="${statusClass}">${statusIcon} Attendance records for today: ${todayRecords.length}/6 employees</p>
                    <p class="info">Total attendance records in system: ${attendanceRecords.length}</p>
                `;

                // Show today's records
                tableBody.innerHTML = '';
                dataServiceEmployees.forEach(emp => {
                    const record = todayRecords.find(r => r.employeeId === emp.id);
                    const hasRecord = !!record;
                    const statusIcon = hasRecord ? '✅' : '❌';
                    const statusClass = hasRecord ? 'success' : 'error';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${emp.id}</td>
                        <td>${emp.firstName} ${emp.lastName}</td>
                        <td>${record?.timeIn || record?.clockIn || 'N/A'}</td>
                        <td>${record?.status || 'No record'}</td>
                        <td class="${statusClass}">${statusIcon}</td>
                    `;
                    tableBody.appendChild(row);
                });

            } catch (error) {
                output.innerHTML = `<p class="error">❌ Error testing attendance coverage: ${error.message}</p>`;
            }
        }

        function generateFinalVerdict() {
            const output = document.getElementById('final-verdict');
            
            // Check all sections for success indicators
            const successElements = document.querySelectorAll('.success');
            const errorElements = document.querySelectorAll('.error');
            
            const hasErrors = errorElements.length > 0;
            
            if (!hasErrors) {
                output.innerHTML = `
                    <h3 class="success">🎉 SYSTEM DATA CONSISTENCY: PERFECT</h3>
                    <p class="success">✅ All 6 employees are consistently represented across all system components</p>
                    <p class="success">✅ Employee attendance records are using the same data source</p>
                    <p class="success">✅ All modules are properly integrated with the centralized data service</p>
                    <p class="info"><strong>System Status:</strong> All employee data and attendance records are now consistent throughout the system!</p>
                `;
            } else {
                output.innerHTML = `
                    <h3 class="error">❌ SYSTEM DATA CONSISTENCY: ISSUES DETECTED</h3>
                    <p class="error">Some modules are still not using consistent data sources.</p>
                    <p class="warning">Please check the detailed results above for specific issues.</p>
                `;
            }
        }

        // Run complete test when page loads
        window.addEventListener('DOMContentLoaded', runCompleteTest);
    </script>
</body>
</html>
