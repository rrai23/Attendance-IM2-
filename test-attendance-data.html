<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Attendance Data Verification</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2 { color: #333; }
        .test-section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
        .status-present { color: green; }
        .status-late { color: orange; }
        .status-absent { color: red; }
        .status-overtime { color: purple; }
    </style>
</head>
<body>
    <h1>Employee Attendance Data Verification</h1>
    <p>This page verifies that the employee attendance module is using the same data as the rest of the system.</p>

    <div class="test-section">
        <h2>1. Employee Data Consistency</h2>
        <div id="employee-consistency"></div>
        <table id="employee-comparison">
            <thead>
                <tr>
                    <th>Employee ID</th>
                    <th>Name (Data Service)</th>
                    <th>Name (Attendance Module)</th>
                    <th>Department</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="test-section">
        <h2>2. Today's Attendance Records</h2>
        <div id="attendance-summary"></div>
        <table id="attendance-records">
            <thead>
                <tr>
                    <th>Employee ID</th>
                    <th>Employee Name</th>
                    <th>Time In</th>
                    <th>Time Out</th>
                    <th>Status</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="test-section">
        <h2>3. Data Source Verification</h2>
        <div id="data-source-verification"></div>
    </div>

    <script src="js/mock-data.js"></script>
    <script src="js/data-service.js"></script>
    <script src="js/employee-attendance.js"></script>
    <script>
        let dataService;
        let attendanceManager;
        let dataServiceEmployees = [];
        let attendanceEmployees = [];
        let attendanceRecords = [];

        async function runVerification() {
            try {
                // Initialize services
                dataService = new DataService();
                attendanceManager = new EmployeeAttendanceManager();

                await verifyEmployeeData();
                await verifyAttendanceRecords();
                await verifyDataSources();

            } catch (error) {
                console.error('Verification failed:', error);
                document.body.innerHTML += `<div class="error">Verification failed: ${error.message}</div>`;
            }
        }

        async function verifyEmployeeData() {
            const output = document.getElementById('employee-consistency');
            const tableBody = document.querySelector('#employee-comparison tbody');

            try {
                // Get employees from both sources
                dataServiceEmployees = await dataService.getEmployees();
                await attendanceManager.init();
                attendanceEmployees = attendanceManager.employees;

                // Check if counts match
                if (dataServiceEmployees.length === attendanceEmployees.length && dataServiceEmployees.length === 6) {
                    output.innerHTML = `<p class="success">✅ Employee count matches: ${dataServiceEmployees.length} employees in both systems</p>`;
                } else {
                    output.innerHTML = `<p class="error">❌ Employee count mismatch: Data Service (${dataServiceEmployees.length}), Attendance Module (${attendanceEmployees.length})</p>`;
                }

                // Display comparison table
                tableBody.innerHTML = '';
                const maxLength = Math.max(dataServiceEmployees.length, attendanceEmployees.length);
                
                for (let i = 0; i < maxLength; i++) {
                    const dsEmp = dataServiceEmployees[i];
                    const attEmp = attendanceEmployees.find(emp => emp.id === dsEmp?.id);
                    
                    const row = document.createElement('tr');
                    const namesMatch = dsEmp && attEmp && dsEmp.firstName + ' ' + dsEmp.lastName === attEmp.name;
                    const status = namesMatch ? '✅ Match' : '❌ Mismatch';
                    
                    row.innerHTML = `
                        <td>${dsEmp?.id || 'N/A'}</td>
                        <td>${dsEmp ? dsEmp.firstName + ' ' + dsEmp.lastName : 'N/A'}</td>
                        <td>${attEmp?.name || 'N/A'}</td>
                        <td>${dsEmp?.department || 'N/A'}</td>
                        <td class="${namesMatch ? 'success' : 'error'}">${status}</td>
                    `;
                    tableBody.appendChild(row);
                }

            } catch (error) {
                output.innerHTML = `<p class="error">❌ Error verifying employee data: ${error.message}</p>`;
            }
        }

        async function verifyAttendanceRecords() {
            const output = document.getElementById('attendance-summary');
            const tableBody = document.querySelector('#attendance-records tbody');

            try {
                attendanceRecords = attendanceManager.attendanceRecords;
                
                // Filter today's records (July 12, 2025)
                const today = '2025-07-12';
                const todayRecords = attendanceRecords.filter(record => record.date === today);

                if (todayRecords.length === 6) {
                    output.innerHTML = `<p class="success">✅ Found ${todayRecords.length} attendance records for today (all employees)</p>`;
                } else {
                    output.innerHTML = `<p class="warning">⚠️ Found ${todayRecords.length} attendance records for today (expected 6)</p>`;
                }

                // Display today's attendance records
                tableBody.innerHTML = '';
                todayRecords.forEach(record => {
                    const employee = attendanceEmployees.find(emp => emp.id === record.employeeId);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.employeeId}</td>
                        <td>${employee?.name || 'Unknown'}</td>
                        <td>${record.clockIn || record.timeIn || 'N/A'}</td>
                        <td>${record.clockOut || record.timeOut || 'Still working'}</td>
                        <td class="status-${record.status}">${record.status}</td>
                        <td>${record.notes || ''}</td>
                    `;
                    tableBody.appendChild(row);
                });

            } catch (error) {
                output.innerHTML = `<p class="error">❌ Error verifying attendance records: ${error.message}</p>`;
            }
        }

        async function verifyDataSources() {
            const output = document.getElementById('data-source-verification');
            
            try {
                // Check if attendance module is using data service
                const usingDataService = typeof dataService !== 'undefined' && attendanceManager.employees.length === 6;
                
                // Get stats from data service for comparison
                const stats = await dataService.getAttendanceStats();
                
                let message = '';
                if (usingDataService) {
                    message += '<p class="success">✅ Employee Attendance Module is using Data Service</p>';
                } else {
                    message += '<p class="error">❌ Employee Attendance Module is NOT using Data Service</p>';
                }

                message += `<p><strong>Data Service Stats:</strong> ${stats.totalEmployees} total employees</p>`;
                message += `<p><strong>Attendance Module:</strong> ${attendanceManager.employees.length} employees loaded</p>`;
                message += `<p><strong>Attendance Records:</strong> ${attendanceRecords.length} total records</p>`;

                // Check for data consistency
                const allEmployeesHaveRecords = dataServiceEmployees.every(emp => 
                    attendanceRecords.some(record => record.employeeId === emp.id)
                );

                if (allEmployeesHaveRecords) {
                    message += '<p class="success">✅ All employees have attendance records</p>';
                } else {
                    message += '<p class="warning">⚠️ Some employees missing attendance records</p>';
                }

                output.innerHTML = message;

            } catch (error) {
                output.innerHTML = `<p class="error">❌ Error verifying data sources: ${error.message}</p>`;
            }
        }

        // Run verification when page loads
        window.addEventListener('DOMContentLoaded', runVerification);
    </script>
</body>
</html>
