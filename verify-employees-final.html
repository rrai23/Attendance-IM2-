<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Verification - Employees Page Unified Data Service</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .verification-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .verification-section h3 { margin-top: 0; color: #333; }
        .check-item { display: flex; align-items: center; margin: 8px 0; }
        .check-item .icon { margin-right: 10px; font-size: 18px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #dee2e6; }
        .stat-value { font-size: 24px; font-weight: bold; color: #007bff; }
        .stat-label { color: #6c757d; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Final Verification - Employees Page Unified Data Service</h1>
        <p>This comprehensive test verifies that the employees page is fully integrated with the unified data service and working correctly.</p>
        
        <div id="overall-status" class="status info">Initializing verification...</div>
        
        <!-- Data Service Verification -->
        <div class="verification-section">
            <h3>üì° Data Service Verification</h3>
            <div id="dataservice-checks">
                <div class="check-item">
                    <span class="icon">‚è≥</span>
                    <span>Data service initialization...</span>
                </div>
            </div>
        </div>
        
        <!-- Employees Manager Verification -->
        <div class="verification-section">
            <h3>üë• Employees Manager Verification</h3>
            <div id="manager-checks">
                <div class="check-item">
                    <span class="icon">‚è≥</span>
                    <span>Employees manager initialization...</span>
                </div>
            </div>
        </div>
        
        <!-- CRUD Operations Verification -->
        <div class="verification-section">
            <h3>‚öôÔ∏è CRUD Operations Verification</h3>
            <div id="crud-checks">
                <div class="check-item">
                    <span class="icon">‚è≥</span>
                    <span>CRUD operations testing...</span>
                </div>
            </div>
            <button onclick="runCRUDTests()">Run CRUD Tests</button>
        </div>
        
        <!-- Data Sync Verification -->
        <div class="verification-section">
            <h3>üîÑ Data Sync Verification</h3>
            <div id="sync-checks">
                <div class="check-item">
                    <span class="icon">‚è≥</span>
                    <span>Data sync testing...</span>
                </div>
            </div>
            <button onclick="testDataSync()">Test Data Sync</button>
        </div>
        
        <!-- Current State Display -->
        <div class="verification-section">
            <h3>üìä Current State</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="employee-count">-</div>
                    <div class="stat-label">Total Employees</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="department-count">-</div>
                    <div class="stat-label">Departments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="active-count">-</div>
                    <div class="stat-label">Active Employees</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dataservice-type">-</div>
                    <div class="stat-label">Data Service Type</div>
                </div>
            </div>
            <button onclick="refreshCurrentState()">Refresh State</button>
        </div>
        
        <!-- Test Results -->
        <div class="verification-section">
            <h3>üìã Test Results</h3>
            <div id="test-results"></div>
            <button onclick="clearResults()">Clear Results</button>
        </div>
    </div>

    <!-- Load all required scripts -->
    <script src="js/mock-data.js"></script>
    <script src="js/core/data-service-api.js"></script>
    <script src="js/core/local-storage-service.js"></script>
    <script src="js/core/api-service.js"></script>
    <script src="js/core/data-service-factory.js"></script>
    <script src="js/unified-data-service.js"></script>
    <script src="js/data-service.js"></script>
    <script src="js/employees-page.js"></script>

    <script>
        let verificationResults = [];
        let employeesManager;

        function updateCheck(containerId, checks) {
            const container = document.getElementById(containerId);
            container.innerHTML = checks.map(check => `
                <div class="check-item">
                    <span class="icon">${check.passed ? '‚úÖ' : check.failed ? '‚ùå' : '‚è≥'}</span>
                    <span>${check.text}</span>
                </div>
            `).join('');
        }

        function updateOverallStatus(message, type = 'info') {
            const status = document.getElementById('overall-status');
            status.className = `status ${type}`;
            status.textContent = message;
        }

        function addTestResult(test, success, message, data = null) {
            const container = document.getElementById('test-results');
            const result = document.createElement('div');
            result.className = `status ${success ? 'success' : 'error'}`;
            result.innerHTML = `
                <strong>${success ? '‚úÖ' : '‚ùå'} ${test}</strong><br>
                ${message}
                ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}
            `;
            container.insertBefore(result, container.firstChild);
            
            verificationResults.push({
                test,
                success,
                message,
                data,
                timestamp: new Date().toISOString()
            });
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            verificationResults = [];
        }

        async function refreshCurrentState() {
            try {
                if (!window.dataService?.initialized) {
                    throw new Error('Data service not available');
                }

                const employees = await window.dataService.getEmployees();
                const departments = [...new Set(employees.map(emp => emp.department).filter(Boolean))];
                const activeEmployees = employees.filter(emp => emp.status === 'active');

                document.getElementById('employee-count').textContent = employees.length;
                document.getElementById('department-count').textContent = departments.length;
                document.getElementById('active-count').textContent = activeEmployees.length;
                document.getElementById('dataservice-type').textContent = window.dataService.constructor.name;

                addTestResult('Refresh State', true, 'Current state refreshed successfully', {
                    totalEmployees: employees.length,
                    departments: departments.length,
                    activeEmployees: activeEmployees.length
                });

            } catch (error) {
                addTestResult('Refresh State', false, error.message);
            }
        }

        async function runCRUDTests() {
            const tests = [
                {
                    name: 'Create Employee',
                    test: async () => {
                        const testEmployee = {
                            firstName: 'Verification',
                            lastName: 'Test',
                            email: 'verification.test@example.com',
                            department: 'Testing',
                            role: 'employee',
                            status: 'active',
                            hireDate: new Date().toISOString().split('T')[0],
                            salary: 60000,
                            hourlyRate: 30
                        };
                        return await window.dataService.addEmployee(testEmployee);
                    }
                },
                {
                    name: 'Read Employees',
                    test: async () => {
                        const employees = await window.dataService.getEmployees();
                        if (employees.length === 0) throw new Error('No employees found');
                        return { count: employees.length };
                    }
                },
                {
                    name: 'Update Employee',
                    test: async () => {
                        const employees = await window.dataService.getEmployees();
                        const testEmployee = employees.find(emp => emp.firstName === 'Verification');
                        if (!testEmployee) throw new Error('Test employee not found');
                        
                        return await window.dataService.updateEmployee(testEmployee.id, {
                            salary: 65000,
                            updatedAt: new Date().toISOString()
                        });
                    }
                },
                {
                    name: 'Delete Employee',
                    test: async () => {
                        const employees = await window.dataService.getEmployees();
                        const testEmployee = employees.find(emp => emp.firstName === 'Verification');
                        if (!testEmployee) throw new Error('Test employee not found');
                        
                        return await window.dataService.deleteEmployee(testEmployee.id);
                    }
                }
            ];

            for (const { name, test } of tests) {
                try {
                    const result = await test();
                    addTestResult(name, true, 'Test passed successfully', result);
                } catch (error) {
                    addTestResult(name, false, error.message);
                }
            }

            updateCheck('crud-checks', [
                { text: 'CRUD operations completed', passed: true }
            ]);

            await refreshCurrentState();
        }

        async function testDataSync() {
            try {
                let syncEventReceived = false;
                
                // Listen for sync events
                if (window.dataService.addEventListener) {
                    window.dataService.addEventListener('employeeUpdate', () => {
                        syncEventReceived = true;
                        addTestResult('Data Sync Event', true, 'Employee update event received');
                    });
                }

                // Trigger an update to test sync
                const employees = await window.dataService.getEmployees();
                if (employees.length > 0) {
                    await window.dataService.updateEmployee(employees[0].id, {
                        syncTest: new Date().toISOString()
                    });
                    
                    // Wait for sync event
                    setTimeout(() => {
                        if (!syncEventReceived) {
                            addTestResult('Data Sync Event', false, 'No sync event received within timeout');
                        }
                    }, 1000);
                }

                updateCheck('sync-checks', [
                    { text: 'Data sync test completed', passed: true }
                ]);

            } catch (error) {
                addTestResult('Data Sync Test', false, error.message);
                updateCheck('sync-checks', [
                    { text: 'Data sync test failed', failed: true }
                ]);
            }
        }

        async function verifyDataService() {
            const checks = [];
            
            try {
                // Check if dataService exists
                if (typeof window.dataService === 'undefined') {
                    checks.push({ text: 'window.dataService exists', failed: true });
                    return checks;
                } else {
                    checks.push({ text: 'window.dataService exists', passed: true });
                }

                // Check if initialized
                if (!window.dataService.initialized) {
                    checks.push({ text: 'Data service initialized', failed: true });
                } else {
                    checks.push({ text: 'Data service initialized', passed: true });
                }

                // Check required methods
                const requiredMethods = ['getEmployees', 'addEmployee', 'updateEmployee', 'deleteEmployee'];
                for (const method of requiredMethods) {
                    if (typeof window.dataService[method] === 'function') {
                        checks.push({ text: `Method ${method} available`, passed: true });
                    } else {
                        checks.push({ text: `Method ${method} available`, failed: true });
                    }
                }

                // Test basic functionality
                const employees = await window.dataService.getEmployees();
                checks.push({ text: `getEmployees() works (${employees.length} employees)`, passed: true });

            } catch (error) {
                checks.push({ text: `Data service verification failed: ${error.message}`, failed: true });
            }

            return checks;
        }

        async function verifyEmployeesManager() {
            const checks = [];
            
            try {
                // Initialize employees manager
                employeesManager = new EmployeesPageManager();
                checks.push({ text: 'EmployeesPageManager instantiated', passed: true });

                // Test initialization
                await employeesManager.init();
                checks.push({ text: 'EmployeesPageManager initialized', passed: true });

                // Check if it's using the unified manager
                if (employeesManager.unifiedManager === window.dataService) {
                    checks.push({ text: 'Using unified data service', passed: true });
                } else {
                    checks.push({ text: 'Using unified data service', failed: true });
                }

                // Check if employees are loaded
                if (employeesManager.employees && employeesManager.employees.length >= 0) {
                    checks.push({ text: `Employees loaded (${employeesManager.employees.length})`, passed: true });
                } else {
                    checks.push({ text: 'Employees loaded', failed: true });
                }

            } catch (error) {
                checks.push({ text: `Employees manager verification failed: ${error.message}`, failed: true });
            }

            return checks;
        }

        // Main verification process
        document.addEventListener('DOMContentLoaded', async function() {
            updateOverallStatus('Starting verification process...', 'info');

            try {
                // Wait for data service
                let attempts = 0;
                while ((!window.dataService || !window.dataService.initialized) && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                if (!window.dataService || !window.dataService.initialized) {
                    updateOverallStatus('‚ùå Data service failed to initialize', 'error');
                    return;
                }

                // Run verifications
                const dataServiceChecks = await verifyDataService();
                updateCheck('dataservice-checks', dataServiceChecks);

                const managerChecks = await verifyEmployeesManager();
                updateCheck('manager-checks', managerChecks);

                // Update current state
                await refreshCurrentState();

                // Check overall success
                const allPassed = [...dataServiceChecks, ...managerChecks].every(check => check.passed);
                if (allPassed) {
                    updateOverallStatus('‚úÖ All verifications passed! Employees page is fully integrated with unified data service.', 'success');
                } else {
                    updateOverallStatus('‚ö†Ô∏è Some verifications failed. Check details above.', 'warning');
                }

            } catch (error) {
                console.error('Verification error:', error);
                updateOverallStatus('‚ùå Verification process failed: ' + error.message, 'error');
            }
        });
    </script>
</body>
</html>
