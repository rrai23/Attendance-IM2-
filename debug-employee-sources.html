<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Data Source Debug Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .employee-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            margin: 5px 0;
        }
        .source-label {
            font-weight: bold;
            color: #0d6efd;
        }
        .count-badge {
            background: #198754;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <h1>üîç Employee Data Source Debug Tool</h1>
        <p class="text-muted">Investigate where the 6 employees are coming from</p>
        
        <button id="debugBtn" class="btn btn-primary mb-3">üîç Debug All Data Sources</button>
        <button id="clearStorage" class="btn btn-warning mb-3 ms-2">üóëÔ∏è Clear localStorage</button>
        
        <div id="debugResults"></div>
    </div>

    <!-- Load all the same scripts as employees.html -->
    <script src="js/mock-data.js"></script>
    <script src="js/core/data-service-api.js"></script>
    <script src="js/core/local-storage-service.js"></script>
    <script src="js/core/api-service.js"></script>
    <script src="js/core/data-service-factory.js"></script>
    <script src="js/unified-data-service.js"></script>
    <script src="js/data-service.js"></script>
    <script src="js/unified-employee-manager.js"></script>

    <script>
        async function debugAllSources() {
            const results = document.getElementById('debugResults');
            results.innerHTML = '<h3>üîç Debugging Employee Data Sources...</h3>';
            
            try {
                // 1. Check localStorage directly
                addDebugSection('localStorage Raw Data', () => {
                    const stored = localStorage.getItem('bricks_attendance_data');
                    if (stored) {
                        const data = JSON.parse(stored);
                        return {
                            employees: data.employees || [],
                            message: `Found ${data.employees?.length || 0} employees in localStorage`
                        };
                    } else {
                        return {
                            employees: [],
                            message: 'No data in localStorage'
                        };
                    }
                });

                // 2. Check mock data from data.json
                addDebugSection('Mock Data (data.json)', async () => {
                    try {
                        const response = await fetch('/mock/data.json');
                        const data = await response.json();
                        return {
                            employees: data.employees || [],
                            message: `Found ${data.employees?.length || 0} employees in data.json`
                        };
                    } catch (error) {
                        return {
                            employees: [],
                            message: `Error loading data.json: ${error.message}`
                        };
                    }
                });

                // 3. Check window.mockData
                addDebugSection('window.mockData', () => {
                    if (typeof window.mockData !== 'undefined') {
                        const employees = window.mockData.employees || [];
                        return {
                            employees,
                            message: `Found ${employees.length} employees in window.mockData`
                        };
                    } else {
                        return {
                            employees: [],
                            message: 'window.mockData not available'
                        };
                    }
                });

                // 4. Check unified employee manager
                addDebugSection('Unified Employee Manager', () => {
                    if (typeof UnifiedEmployeeManager !== 'undefined') {
                        const manager = new UnifiedEmployeeManager();
                        return {
                            employees: manager.employees || [],
                            message: `Found ${manager.employees?.length || 0} employees in UnifiedEmployeeManager`
                        };
                    } else {
                        return {
                            employees: [],
                            message: 'UnifiedEmployeeManager not available'
                        };
                    }
                });

                // 5. Check window.dataService
                addDebugSection('window.dataService', async () => {
                    if (window.dataService && window.dataService.getEmployees) {
                        const employees = await window.dataService.getEmployees();
                        return {
                            employees,
                            message: `Found ${employees.length} employees via window.dataService`
                        };
                    } else {
                        return {
                            employees: [],
                            message: 'window.dataService not available or not initialized'
                        };
                    }
                });

                // 6. Check LocalStorageDataService directly
                addDebugSection('LocalStorageDataService Direct', async () => {
                    if (typeof LocalStorageDataService !== 'undefined') {
                        const service = new LocalStorageDataService();
                        await service.initializeData();
                        const employees = await service.getEmployees();
                        return {
                            employees,
                            message: `Found ${employees.length} employees via direct LocalStorageDataService`
                        };
                    } else {
                        return {
                            employees: [],
                            message: 'LocalStorageDataService not available'
                        };
                    }
                });

            } catch (error) {
                results.innerHTML += `<div class="alert alert-danger">Error during debugging: ${error.message}</div>`;
            }
        }

        function addDebugSection(title, dataFetcher) {
            const results = document.getElementById('debugResults');
            
            const section = document.createElement('div');
            section.className = 'debug-section';
            
            const header = document.createElement('h4');
            header.innerHTML = `<span class="source-label">${title}</span>`;
            section.appendChild(header);
            
            const loading = document.createElement('div');
            loading.textContent = 'Loading...';
            section.appendChild(loading);
            
            results.appendChild(section);
            
            // Execute the data fetcher (may be sync or async)
            Promise.resolve(dataFetcher()).then(result => {
                loading.remove();
                
                const message = document.createElement('div');
                message.innerHTML = `<span class="count-badge">${result.employees.length}</span> ${result.message}`;
                section.appendChild(message);
                
                if (result.employees.length > 0) {
                    const employeeList = document.createElement('div');
                    employeeList.className = 'mt-2';
                    
                    result.employees.forEach((emp, index) => {
                        const card = document.createElement('div');
                        card.className = 'employee-card';
                        card.innerHTML = `
                            <strong>${emp.fullName || `${emp.firstName} ${emp.lastName}` || emp.name || 'Unknown'}</strong><br>
                            <small>ID: ${emp.id} | Code: ${emp.employeeCode || emp.employeeId || 'N/A'}</small><br>
                            <small>Email: ${emp.email || 'N/A'} | Dept: ${emp.department || 'N/A'}</small>
                        `;
                        employeeList.appendChild(card);
                    });
                    
                    section.appendChild(employeeList);
                }
            }).catch(error => {
                loading.remove();
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger';
                errorDiv.textContent = `Error: ${error.message}`;
                section.appendChild(errorDiv);
            });
        }

        document.getElementById('debugBtn').addEventListener('click', debugAllSources);
        
        document.getElementById('clearStorage').addEventListener('click', () => {
            localStorage.removeItem('bricks_attendance_data');
            alert('localStorage cleared! Click debug again to see the change.');
        });

        // Auto-run on page load
        window.addEventListener('load', () => {
            setTimeout(debugAllSources, 1000); // Give scripts time to load
        });
    </script>
</body>
</html>
