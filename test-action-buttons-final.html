<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Test - Action Buttons Fixed</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; }
        .action-buttons { display: flex; gap: 5px; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .btn-outline { background: transparent; color: #007bff; border: 1px solid #007bff; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow: auto; font-size: 12px; max-height: 150px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úÖ Final Test - Employee Action Buttons Fixed</h1>
        <p>Comprehensive test to verify that edit, view, and delete buttons are working correctly.</p>
        
        <div id="status-container">
            <div class="status info">Loading system components...</div>
        </div>
        
        <div class="test-section">
            <h3>üéØ Test Actions</h3>
            <button onclick="runFullTest()" class="btn-success">Run Full Test</button>
            <button onclick="testButtonClicks()">Test Button Clicks</button>
            <button onclick="simulateWorkflow()">Simulate Workflow</button>
            <button onclick="clearTests()">Clear Tests</button>
            <button onclick="openEmployeesPage()">Open Employees Page</button>
        </div>
        
        <div id="employee-table-section" class="test-section">
            <h3>üìã Test Employee Table</h3>
            <table>
                <thead>
                    <tr>
                        <th>Employee</th>
                        <th>Department</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="employeesTableBody">
                    <!-- Will be populated dynamically -->
                </tbody>
            </table>
        </div>
        
        <div id="test-results" class="test-section">
            <h3>üìä Test Results</h3>
            <div id="results-container"></div>
        </div>
    </div>

    <!-- Load all required scripts -->
    <script src="js/mock-data.js"></script>
    <script src="js/core/data-service-api.js"></script>
    <script src="js/core/local-storage-service.js"></script>
    <script src="js/core/api-service.js"></script>
    <script src="js/core/data-service-factory.js"></script>
    <script src="js/unified-data-service.js"></script>
    <script src="js/data-service.js"></script>
    <script src="js/employees-page.js"></script>

    <script>
        let employeesManager;
        let testResults = [];

        function addStatus(message, type = 'info') {
            const container = document.getElementById('status-container');
            const status = document.createElement('div');
            status.className = `status ${type}`;
            status.innerHTML = message;
            container.appendChild(status);
        }

        function addResult(title, message, type = 'info', data = null) {
            const container = document.getElementById('results-container');
            const result = document.createElement('div');
            result.className = `status ${type}`;
            result.innerHTML = `
                <strong>${title}:</strong> ${message}
                ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}
            `;
            container.appendChild(result);
            
            testResults.push({ title, message, type, data, timestamp: new Date().toISOString() });
        }

        function clearTests() {
            document.getElementById('results-container').innerHTML = '';
            testResults = [];
            addStatus('Tests cleared', 'info');
        }

        async function runFullTest() {
            addStatus('üîç Running comprehensive test...', 'info');
            
            try {
                // Test 1: Data Service
                await testDataService();
                
                // Test 2: Employees Manager
                await testEmployeesManager();
                
                // Test 3: Table Creation
                await testTableCreation();
                
                // Test 4: Button Events
                await testButtonEvents();
                
                // Test 5: Method Availability
                await testMethodAvailability();
                
                addStatus('‚úÖ All tests completed successfully!', 'success');
                
            } catch (error) {
                addStatus(`‚ùå Test failed: ${error.message}`, 'error');
                addResult('Test Error', error.message, 'error');
            }
        }

        async function testDataService() {
            if (!window.dataService || !window.dataService.initialized) {
                throw new Error('Data service not available');
            }
            
            const employees = await window.dataService.getEmployees();
            addResult('Data Service', `Available and working (${employees.length} employees)`, 'success');
            return employees;
        }

        async function testEmployeesManager() {
            if (!employeesManager) {
                employeesManager = new EmployeesPageManager();
                await employeesManager.init();
            }
            
            addResult('Employees Manager', 'Initialized successfully', 'success', {
                employeeCount: employeesManager.employees.length,
                hasUnifiedManager: !!employeesManager.unifiedManager,
                initialized: true
            });
            
            return employeesManager;
        }

        async function testTableCreation() {
            if (!employeesManager.employees || employeesManager.employees.length === 0) {
                throw new Error('No employees to create table');
            }
            
            // Use the actual renderTable method
            employeesManager.renderTable();
            
            const tbody = document.getElementById('employeesTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            addResult('Table Creation', `Table rendered with ${rows.length} rows`, 
                rows.length > 0 ? 'success' : 'error');
            
            return rows.length;
        }

        async function testButtonEvents() {
            const editButtons = document.querySelectorAll('.action-edit');
            const viewButtons = document.querySelectorAll('.action-view');
            const deleteButtons = document.querySelectorAll('.action-delete');
            
            addResult('Button Count', 
                `Edit: ${editButtons.length}, View: ${viewButtons.length}, Delete: ${deleteButtons.length}`, 
                (editButtons.length > 0 && viewButtons.length > 0 && deleteButtons.length > 0) ? 'success' : 'error');
            
            // Test if buttons have data attributes
            const firstEdit = editButtons[0];
            if (firstEdit) {
                const employeeId = firstEdit.dataset.employeeId;
                addResult('Button Data', `First edit button has employee ID: ${employeeId}`, 
                    employeeId ? 'success' : 'error');
            }
            
            return { editButtons: editButtons.length, viewButtons: viewButtons.length, deleteButtons: deleteButtons.length };
        }

        async function testMethodAvailability() {
            const methods = [
                'openModal',
                'openViewModal', 
                'openDeleteModal',
                'closeModal',
                'closeViewModal',
                'closeDeleteModal',
                'showError',
                'showSuccess',
                'addActionButtonListeners'
            ];
            
            const available = methods.filter(method => typeof employeesManager[method] === 'function');
            const missing = methods.filter(method => typeof employeesManager[method] !== 'function');
            
            addResult('Method Availability', 
                `Available: ${available.length}/${methods.length}`, 
                missing.length === 0 ? 'success' : 'error',
                { available, missing });
            
            return { available, missing };
        }

        async function testButtonClicks() {
            try {
                addStatus('Testing button clicks...', 'info');
                
                // Mock the modal methods to test without UI interference
                const originalMethods = {
                    openModal: employeesManager.openModal,
                    openViewModal: employeesManager.openViewModal,
                    openDeleteModal: employeesManager.openDeleteModal
                };
                
                let clickResults = { edit: false, view: false, delete: false };
                
                employeesManager.openModal = function(employee) {
                    clickResults.edit = true;
                    addResult('Edit Button Click', `Opened edit modal for ${this.getEmployeeName(employee)}`, 'success');
                };
                
                employeesManager.openViewModal = function(employee) {
                    clickResults.view = true;
                    addResult('View Button Click', `Opened view modal for ${this.getEmployeeName(employee)}`, 'success');
                };
                
                employeesManager.openDeleteModal = function(employee) {
                    clickResults.delete = true;
                    addResult('Delete Button Click', `Opened delete modal for ${this.getEmployeeName(employee)}`, 'success');
                };
                
                // Click buttons
                const editBtn = document.querySelector('.action-edit');
                const viewBtn = document.querySelector('.action-view');
                const deleteBtn = document.querySelector('.action-delete');
                
                if (editBtn) editBtn.click();
                if (viewBtn) setTimeout(() => viewBtn.click(), 100);
                if (deleteBtn) setTimeout(() => deleteBtn.click(), 200);
                
                setTimeout(() => {
                    // Restore original methods
                    Object.assign(employeesManager, originalMethods);
                    
                    const successCount = Object.values(clickResults).filter(Boolean).length;
                    addResult('Button Click Test', 
                        `${successCount}/3 buttons working correctly`, 
                        successCount === 3 ? 'success' : 'warning');
                }, 500);
                
            } catch (error) {
                addResult('Button Click Test', `Error: ${error.message}`, 'error');
            }
        }

        async function simulateWorkflow() {
            addStatus('üîÑ Simulating complete workflow...', 'info');
            
            try {
                // Simulate edit workflow
                const employee = employeesManager.employees[0];
                addResult('Workflow Test', `Starting workflow with employee: ${employeesManager.getEmployeeName(employee)}`, 'info');
                
                // Test edit
                setTimeout(() => {
                    const editBtn = document.querySelector(`[data-employee-id="${employee.id}"].action-edit`);
                    if (editBtn) {
                        editBtn.click();
                        addResult('Edit Workflow', 'Edit button clicked successfully', 'success');
                    }
                }, 100);
                
                // Test view
                setTimeout(() => {
                    const viewBtn = document.querySelector(`[data-employee-id="${employee.id}"].action-view`);
                    if (viewBtn) {
                        viewBtn.click();
                        addResult('View Workflow', 'View button clicked successfully', 'success');
                    }
                }, 300);
                
                // Test delete (but don't actually delete)
                setTimeout(() => {
                    const deleteBtn = document.querySelector(`[data-employee-id="${employee.id}"].action-delete`);
                    if (deleteBtn) {
                        deleteBtn.click();
                        addResult('Delete Workflow', 'Delete button clicked successfully', 'success');
                    }
                }, 500);
                
            } catch (error) {
                addResult('Workflow Test', `Error: ${error.message}`, 'error');
            }
        }

        function openEmployeesPage() {
            window.open('employees.html', '_blank');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            addStatus('üöÄ Initializing test environment...', 'info');
            
            // Wait for data service
            let attempts = 0;
            while ((!window.dataService || !window.dataService.initialized) && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }

            if (window.dataService && window.dataService.initialized) {
                addStatus('‚úÖ Data service ready', 'success');
                
                // Auto-initialize employees manager
                try {
                    employeesManager = new EmployeesPageManager();
                    await employeesManager.init();
                    addStatus('‚úÖ Employees manager initialized', 'success');
                    
                    // Render the table automatically
                    employeesManager.renderTable();
                    addStatus('‚úÖ Employee table rendered', 'success');
                    
                    addStatus('üéØ Ready for testing! Click "Run Full Test" to start.', 'success');
                    
                } catch (error) {
                    addStatus(`‚ùå Failed to initialize: ${error.message}`, 'error');
                }
            } else {
                addStatus('‚ùå Data service failed to initialize', 'error');
            }
        });
    </script>
</body>
</html>
