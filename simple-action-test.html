<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Action Buttons Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .debug-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 1rem;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.9em;
        }
        .success { background-color: #d1ecf1; border-color: #bee5eb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Simple Action Buttons Test</h1>
        <p>Direct test of the action button functionality using mock data.</p>
        
        <div id="results"></div>
        
        <div class="mt-4">
            <h3>Test Employee Buttons</h3>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Department</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="employeeTableBody">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Load scripts in minimal order -->
    <script src="js/mock-data.js"></script>
    
    <script>
        function addResult(type, message) {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `debug-box ${type}`;
            div.innerHTML = `<strong>${type.toUpperCase()}:</strong> ${message}`;
            resultsDiv.appendChild(div);
        }
        
        // Mock employees data directly from mockData
        let employees = [];
        
        function initializeMockEmployees() {
            if (typeof mockData !== 'undefined' && mockData.users) {
                // Convert users to employees (same as the data service does)
                employees = mockData.users
                    .map(user => {
                        if (user.employee) {
                            const employee = { ...user.employee };
                            
                            // Ensure fullName property exists
                            if (!employee.fullName && employee.firstName && employee.lastName) {
                                employee.fullName = `${employee.firstName} ${employee.lastName}`;
                            }
                            
                            // Ensure name property exists
                            if (!employee.name && employee.fullName) {
                                employee.name = employee.fullName;
                            }
                            
                            return employee;
                        }
                        return null;
                    })
                    .filter(Boolean);
                    
                addResult('success', `Loaded ${employees.length} employees from mock data`);
                return true;
            } else {
                addResult('error', 'Mock data not available');
                return false;
            }
        }
        
        /**
         * Enhanced findEmployeeById function (same as in the fix)
         */
        function findEmployeeById(rawId) {
            if (!rawId || !employees || !Array.isArray(employees)) {
                console.warn('Invalid parameters for findEmployeeById:', { rawId, employeesCount: employees?.length });
                return null;
            }

            // Try multiple lookup strategies to handle type mismatches
            const strategies = [
                // Strategy 1: Direct loose comparison (handles both string and number)
                (id) => employees.find(emp => emp.id == id),
                // Strategy 2: Parse as number and compare strictly
                (id) => {
                    const numId = parseInt(id);
                    return !isNaN(numId) ? employees.find(emp => emp.id === numId) : null;
                },
                // Strategy 3: Convert both to strings and compare
                (id) => employees.find(emp => String(emp.id) === String(id)),
                // Strategy 4: Strict equality with original type
                (id) => employees.find(emp => emp.id === id)
            ];

            for (let i = 0; i < strategies.length; i++) {
                const result = strategies[i](rawId);
                if (result) {
                    console.log(`Employee found using strategy ${i + 1}:`, result.name || result.fullName);
                    return result;
                }
            }

            console.warn('Employee not found with any strategy. ID:', rawId, 'Type:', typeof rawId);
            return null;
        }
        
        function createEmployeeTable() {
            const tableBody = document.getElementById('employeeTableBody');
            
            if (employees.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4">No employees available</td></tr>';
                return;
            }
            
            // Show first 3 employees for testing
            const testEmployees = employees.slice(0, 3);
            
            tableBody.innerHTML = testEmployees.map(emp => `
                <tr>
                    <td>${emp.id} <small>(${typeof emp.id})</small></td>
                    <td>${emp.name || emp.fullName || 'No Name'}</td>
                    <td>${emp.department || 'No Department'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary test-edit" data-employee-id="${emp.id}">Edit</button>
                        <button class="btn btn-sm btn-info test-view" data-employee-id="${emp.id}">View</button>
                        <button class="btn btn-sm btn-danger test-delete" data-employee-id="${emp.id}">Delete</button>
                    </td>
                </tr>
            `).join('');
            
            addResult('success', `Created table with ${testEmployees.length} test employees`);
        }
        
        function addButtonListeners() {
            // Add event listeners for action buttons (same pattern as the fix)
            document.querySelectorAll('.test-edit').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const rawId = e.currentTarget.dataset.employeeId;
                    const employee = findEmployeeById(rawId);
                    
                    if (employee) {
                        addResult('success', `EDIT: Found employee "${employee.name || employee.fullName}" (ID: ${employee.id})`);
                    } else {
                        addResult('error', `EDIT: Employee not found (ID: ${rawId}, type: ${typeof rawId})`);
                    }
                });
            });

            document.querySelectorAll('.test-view').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const rawId = e.currentTarget.dataset.employeeId;
                    const employee = findEmployeeById(rawId);
                    
                    if (employee) {
                        addResult('success', `VIEW: Found employee "${employee.name || employee.fullName}" (ID: ${employee.id})`);
                    } else {
                        addResult('error', `VIEW: Employee not found (ID: ${rawId}, type: ${typeof rawId})`);
                    }
                });
            });

            document.querySelectorAll('.test-delete').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const rawId = e.currentTarget.dataset.employeeId;
                    const employee = findEmployeeById(rawId);
                    
                    if (employee) {
                        addResult('success', `DELETE: Found employee "${employee.name || employee.fullName}" (ID: ${employee.id})`);
                    } else {
                        addResult('error', `DELETE: Employee not found (ID: ${rawId}, type: ${typeof rawId})`);
                    }
                });
            });
            
            addResult('success', 'Button event listeners added. Click buttons above to test!');
        }
        
        function runTest() {
            addResult('info', 'Starting simple action buttons test...');
            
            // Step 1: Initialize mock employees
            if (!initializeMockEmployees()) {
                return;
            }
            
            // Step 2: Show employee data types
            employees.slice(0, 3).forEach((emp, index) => {
                addResult('info', `Employee ${index + 1}: ID=${emp.id} (${typeof emp.id}), Name="${emp.name || emp.fullName}"`);
            });
            
            // Step 3: Create test table
            createEmployeeTable();
            
            // Step 4: Add button listeners
            addButtonListeners();
        }
        
        // Run test when page loads
        document.addEventListener('DOMContentLoaded', runTest);
    </script>
</body>
</html>
