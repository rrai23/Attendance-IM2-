<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Test - Employee Names Fixed</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .employee-card { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #007bff; }
        .employee-name { font-weight: bold; font-size: 16px; color: #333; }
        .employee-details { font-size: 14px; color: #666; margin-top: 5px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow: auto; font-size: 12px; max-height: 200px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚úÖ Final Test - Employee Names Fixed</h1>
        <p>Verifying that employee names are now displaying correctly after the fix.</p>
        
        <div id="status-container">
            <div class="status info">Loading and testing employee data...</div>
        </div>
        
        <button onclick="runFullTest()">Run Full Test</button>
        <button onclick="clearAndReload()">Clear Data & Reload</button>
        <button onclick="openEmployeesPage()">Open Employees Page</button>
        
        <div id="employee-list"></div>
        
        <div id="test-results"></div>
    </div>

    <!-- Load all required scripts -->
    <script src="js/mock-data.js"></script>
    <script src="js/core/data-service-api.js"></script>
    <script src="js/core/local-storage-service.js"></script>
    <script src="js/core/api-service.js"></script>
    <script src="js/core/data-service-factory.js"></script>
    <script src="js/unified-data-service.js"></script>
    <script src="js/data-service.js"></script>
    <script src="js/employees-page.js"></script>

    <script>
        function addStatus(message, type = 'info') {
            const container = document.getElementById('status-container');
            const status = document.createElement('div');
            status.className = `status ${type}`;
            status.innerHTML = message;
            container.appendChild(status);
        }

        function displayEmployees(employees) {
            const container = document.getElementById('employee-list');
            
            if (employees.length === 0) {
                container.innerHTML = '<div class="status error">No employees found</div>';
                return;
            }

            container.innerHTML = `
                <h3>Employee List (${employees.length} employees)</h3>
                ${employees.map(emp => `
                    <div class="employee-card">
                        <div class="employee-name">${getEmployeeName(emp)}</div>
                        <div class="employee-details">
                            ID: ${emp.id} | Code: ${emp.employeeCode || 'N/A'} | 
                            Department: ${emp.department || 'N/A'} | 
                            Position: ${emp.position || emp.role || 'N/A'}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function getEmployeeName(employee) {
            if (employee.fullName) {
                return employee.fullName;
            }
            
            const firstName = employee.firstName || '';
            const lastName = employee.lastName || '';
            
            if (firstName && lastName) {
                return `${firstName} ${lastName}`;
            } else if (firstName) {
                return firstName;
            } else if (lastName) {
                return lastName;
            } else if (employee.name) {
                return employee.name;
            } else {
                return `Employee ${employee.id || 'Unknown'}`;
            }
        }

        async function runFullTest() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<h3>Test Results</h3>';
            
            try {
                // Test 1: Data Service Available
                if (!window.dataService || !window.dataService.initialized) {
                    throw new Error('Data service not available');
                }
                addResult('‚úÖ Data service available', 'success');

                // Test 2: Load Employees
                const employees = await window.dataService.getEmployees();
                addResult(`‚úÖ Loaded ${employees.length} employees`, 'success');

                if (employees.length === 0) {
                    addResult('‚ö†Ô∏è No employees found - this might be a data issue', 'error');
                    return;
                }

                // Test 3: Check Name Structure
                const nameAnalysis = employees.map(emp => ({
                    id: emp.id,
                    hasFirstName: !!emp.firstName,
                    hasLastName: !!emp.lastName,
                    hasFullName: !!emp.fullName,
                    displayName: getEmployeeName(emp),
                    isValidName: !getEmployeeName(emp).includes('undefined')
                }));

                const validNames = nameAnalysis.filter(n => n.isValidName).length;
                const invalidNames = nameAnalysis.length - validNames;

                if (invalidNames === 0) {
                    addResult(`‚úÖ All ${employees.length} employees have valid names`, 'success');
                } else {
                    addResult(`‚ùå ${invalidNames} employees have invalid names`, 'error');
                }

                // Test 4: Display Employee List
                displayEmployees(employees);

                // Test 5: Structure Verification
                const structureTest = {
                    totalEmployees: employees.length,
                    employeesWithFirstName: nameAnalysis.filter(n => n.hasFirstName).length,
                    employeesWithLastName: nameAnalysis.filter(n => n.hasLastName).length,
                    employeesWithFullName: nameAnalysis.filter(n => n.hasFullName).length,
                    employeesWithValidNames: validNames,
                    sampleEmployee: employees[0],
                    sampleDisplayName: getEmployeeName(employees[0])
                };

                addResult('üìä Structure Analysis', 'info', structureTest);

                // Test 6: Test EmployeesPageManager
                if (typeof EmployeesPageManager !== 'undefined') {
                    const manager = new EmployeesPageManager();
                    await manager.init();
                    
                    if (manager.employees && manager.employees.length > 0) {
                        const managerNameTest = manager.employees.map(emp => getEmployeeName(emp));
                        const validManagerNames = managerNameTest.filter(name => !name.includes('undefined')).length;
                        addResult(`‚úÖ EmployeesPageManager: ${validManagerNames}/${manager.employees.length} valid names`, 'success');
                    }
                }

                addStatus('üéâ All tests completed successfully!', 'success');

            } catch (error) {
                addResult(`‚ùå Test failed: ${error.message}`, 'error');
                addStatus('‚ùå Tests failed', 'error');
            }
        }

        function addResult(title, type, data = null) {
            const container = document.getElementById('test-results');
            const result = document.createElement('div');
            result.className = `status ${type}`;
            result.innerHTML = `
                <strong>${title}</strong>
                ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}
            `;
            container.appendChild(result);
        }

        async function clearAndReload() {
            try {
                localStorage.removeItem('bricks_attendance_data');
                addStatus('üîÑ Cleared localStorage, reloading...', 'info');
                
                // Force reload the page to restart data service
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
                
            } catch (error) {
                addStatus(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function openEmployeesPage() {
            window.open('employees.html', '_blank');
        }

        // Auto-run test when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            // Wait for data service
            let attempts = 0;
            while ((!window.dataService || !window.dataService.initialized) && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }

            if (window.dataService && window.dataService.initialized) {
                setTimeout(runFullTest, 500);
            } else {
                addStatus('‚ùå Data service failed to initialize', 'error');
            }
        });
    </script>
</body>
</html>
