<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Attendance Creation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .debug-section h3 {
            margin-top: 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .log {
            margin: 10px 0;
            padding: 8px;
            border-radius: 3px;
        }
        .log.info { background: #d1ecf1; border-left: 4px solid #17a2b8; }
        .log.success { background: #d4edda; border-left: 4px solid #28a745; }
        .log.warning { background: #fff3cd; border-left: 4px solid #ffc107; }
        .log.error { background: #f8d7da; border-left: 4px solid #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Debug Attendance Creation</h1>
        <p>This page helps debug why attendance records aren't being created for today.</p>
        
        <div class="debug-section">
            <h3>Manager Status</h3>
            <button onclick="checkManagerStatus()">Check Manager Status</button>
            <div id="manager-status"></div>
        </div>
        
        <div class="debug-section">
            <h3>Today's Data</h3>
            <button onclick="checkTodaysData()">Check Today's Attendance</button>
            <div id="todays-data"></div>
        </div>
        
        <div class="debug-section">
            <h3>Force Create Attendance</h3>
            <button onclick="forceCreateAttendance()">Force Create Today's Attendance</button>
            <button onclick="clearAndRecreateAttendance()">Clear All & Recreate</button>
            <button onclick="testDashboardData()">Test Dashboard Data</button>
            <div id="force-create-result"></div>
        </div>
        
        <div class="debug-section">
            <h3>Console Log</h3>
            <div id="console-log"></div>
        </div>
    </div>

    <!-- Load the unified employee manager -->
    <script src="js/mock-data.js"></script>
    <script src="js/unified-employee-manager.js"></script>
    
    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('console-log');
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function checkManagerStatus() {
            const statusDiv = document.getElementById('manager-status');
            try {
                if (!window.unifiedEmployeeManager) {
                    statusDiv.innerHTML = '<div class="log error">‚ùå UnifiedEmployeeManager not found</div>';
                    return;
                }
                
                const manager = window.unifiedEmployeeManager;
                const employees = manager.getEmployees();
                const allAttendance = manager.attendanceRecords || [];
                
                statusDiv.innerHTML = `
                    <div class="log success">‚úÖ UnifiedEmployeeManager found</div>
                    <div class="log info">üìä Employees: ${employees.length}</div>
                    <div class="log info">üìä Total Attendance Records: ${allAttendance.length}</div>
                    <div class="log info">üìä Manager initialized: ${manager.initialized}</div>
                    <pre>${JSON.stringify({
                        employeeCount: employees.length,
                        attendanceCount: allAttendance.length,
                        employees: employees.map(e => ({ id: e.id, name: e.fullName || e.name, status: e.status })),
                        attendanceDates: [...new Set(allAttendance.map(r => r.date))]
                    }, null, 2)}</pre>
                `;
                log(`Manager Status: ${employees.length} employees, ${allAttendance.length} attendance records`, 'success');
            } catch (error) {
                statusDiv.innerHTML = `<div class="log error">‚ùå Error: ${error.message}</div>`;
                log(`Error checking manager status: ${error.message}`, 'error');
            }
        }

        function checkTodaysData() {
            const dataDiv = document.getElementById('todays-data');
            try {
                const today = new Date().toISOString().split('T')[0];
                const manager = window.unifiedEmployeeManager;
                
                if (!manager) {
                    dataDiv.innerHTML = '<div class="log error">‚ùå Manager not found</div>';
                    return;
                }
                
                // Check different ways to get today's data
                const todayAttendance = manager.getTodayAttendance ? manager.getTodayAttendance() : [];
                const todayRecordsFilter = manager.getAttendanceRecords({ date: today });
                const allRecords = manager.attendanceRecords || [];
                const todayRecordsManual = allRecords.filter(r => r.date === today || r.clockInDate === today);
                
                dataDiv.innerHTML = `
                    <div class="log info">üìÖ Today's Date: ${today}</div>
                    <div class="log info">üìä getTodayAttendance(): ${todayAttendance.length} records</div>
                    <div class="log info">üìä getAttendanceRecords({date}): ${todayRecordsFilter.length} records</div>
                    <div class="log info">üìä Manual filter: ${todayRecordsManual.length} records</div>
                    <pre>${JSON.stringify({
                        today,
                        todayAttendance,
                        todayRecordsFilter,
                        todayRecordsManual,
                        allRecordDates: allRecords.map(r => ({ date: r.date, clockInDate: r.clockInDate, employeeName: r.employeeName }))
                    }, null, 2)}</pre>
                `;
                log(`Today's Data: ${todayRecordsFilter.length} attendance records for ${today}`, 'info');
            } catch (error) {
                dataDiv.innerHTML = `<div class="log error">‚ùå Error: ${error.message}</div>`;
                log(`Error checking today's data: ${error.message}`, 'error');
            }
        }

        function forceCreateAttendance() {
            const resultDiv = document.getElementById('force-create-result');
            try {
                const manager = window.unifiedEmployeeManager;
                
                if (!manager) {
                    resultDiv.innerHTML = '<div class="log error">‚ùå Manager not found</div>';
                    return;
                }
                
                log('üîÑ Forcing attendance creation...', 'info');
                
                // Clear existing today's data first
                const today = new Date().toISOString().split('T')[0];
                const beforeCount = manager.attendanceRecords.length;
                
                // Remove any existing today's records
                manager.attendanceRecords = manager.attendanceRecords.filter(r => r.date !== today && r.clockInDate !== today);
                log(`üóëÔ∏è Cleared existing today's records. Before: ${beforeCount}, After: ${manager.attendanceRecords.length}`, 'info');
                
                // Force create today's attendance
                if (manager.ensureTodayAttendanceData) {
                    manager.ensureTodayAttendanceData();
                    log('‚úÖ Called ensureTodayAttendanceData()', 'success');
                } else {
                    log('‚ùå ensureTodayAttendanceData method not found', 'error');
                }
                
                // Save the data
                if (manager.saveData) {
                    manager.saveData();
                    log('üíæ Saved data to localStorage', 'success');
                }
                
                // Check results
                const afterCount = manager.attendanceRecords.length;
                const todayRecords = manager.getAttendanceRecords({ date: today });
                
                resultDiv.innerHTML = `
                    <div class="log success">‚úÖ Attendance creation attempted</div>
                    <div class="log info">üìä Total records: ${beforeCount} ‚Üí ${afterCount} (${afterCount - beforeCount} added)</div>
                    <div class="log info">üìä Today's records: ${todayRecords.length}</div>
                    <pre>${JSON.stringify({
                        today,
                        recordsAdded: afterCount - beforeCount,
                        todayRecords: todayRecords.map(r => ({ 
                            employeeName: r.employeeName, 
                            status: r.status, 
                            timeIn: r.timeIn || r.clockInTime 
                        }))
                    }, null, 2)}</pre>
                `;
                
                log(`‚úÖ Force create completed. Added ${afterCount - beforeCount} records, ${todayRecords.length} for today`, 'success');
                
                // Trigger dashboard refresh if possible
                if (window.dashboardController && window.dashboardController.loadInitialData) {
                    window.dashboardController.loadInitialData().then(() => {
                        log('üîÑ Dashboard data refreshed', 'success');
                    }).catch(err => {
                        log(`‚ùå Dashboard refresh failed: ${err.message}`, 'error');
                    });
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="log error">‚ùå Error: ${error.message}</div>`;
                log(`‚ùå Error forcing attendance creation: ${error.message}`, 'error');
            }
        }

        function clearAndRecreateAttendance() {
            const result = document.getElementById('force-create-result');
            log('üîÑ Clearing and recreating all attendance...');
            
            if (window.unifiedEmployeeManager) {
                // Clear all attendance records
                const originalLength = window.unifiedEmployeeManager.attendanceRecords.length;
                window.unifiedEmployeeManager.attendanceRecords = [];
                log(`Cleared ${originalLength} attendance records`);
                
                // Force recreate today's attendance
                window.unifiedEmployeeManager.ensureTodayAttendanceData();
                
                const newLength = window.unifiedEmployeeManager.attendanceRecords.length;
                log(`Created ${newLength} new attendance records`);
                
                // Save the data
                window.unifiedEmployeeManager.saveData();
                
                const today = new Date().toISOString().split('T')[0];
                const todayRecords = window.unifiedEmployeeManager.getAttendanceRecords({ date: today });
                
                result.innerHTML = `
                    <div class="log success">
                        <strong>Clear & Recreate Results:</strong><br>
                        - Cleared: ${originalLength} records<br>
                        - Created: ${newLength} new records<br>
                        - Today's records: ${todayRecords.length}<br>
                        <br>
                        <strong>Today's Records:</strong><br>
                        ${todayRecords.map(r => `- ${r.employeeName}: ${r.status}`).join('<br>') || 'None created'}
                    </div>
                `;
            } else {
                result.innerHTML = '<div class="log error">Manager not available</div>';
            }
        }
        
        function testDashboardData() {
            const result = document.getElementById('force-create-result');
            log('üìä Testing dashboard data processing...');
            
            if (window.unifiedEmployeeManager) {
                const today = new Date().toISOString().split('T')[0];
                
                // Test the exact same logic the dashboard uses
                const attendanceRecords = window.unifiedEmployeeManager.getAttendanceRecords({ date: today });
                log(`Dashboard would get ${attendanceRecords.length} records for today`);
                
                // Process attendance like dashboard does
                const presentCount = attendanceRecords.filter(r => r.status === 'present').length;
                const lateCount = attendanceRecords.filter(r => r.status === 'late').length;
                const totalEmployees = window.unifiedEmployeeManager.employees.filter(emp => emp.status === 'active').length;
                const absentCount = totalEmployees - presentCount - lateCount;
                
                result.innerHTML = `
                    <div class="log info">
                        <strong>Dashboard Data Test:</strong><br>
                        - Date: ${today}<br>
                        - Total Active Employees: ${totalEmployees}<br>
                        - Attendance Records Found: ${attendanceRecords.length}<br>
                        - Present: ${presentCount}<br>
                        - Late: ${lateCount}<br>
                        - Absent: ${absentCount}<br>
                        <br>
                        <strong>Raw Records:</strong><br>
                        ${attendanceRecords.length > 0 
                            ? attendanceRecords.map(r => `- ${r.employeeName}: ${r.status} (date: ${r.date})`).join('<br>')
                            : 'No records found for today'}
                    </div>
                `;
            } else {
                result.innerHTML = '<div class="log error">Manager not available</div>';
            }
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            log('üöÄ Debug page loaded', 'info');
            
            // Wait for manager to be ready
            setTimeout(function() {
                if (window.unifiedEmployeeManager) {
                    log('‚úÖ UnifiedEmployeeManager detected', 'success');
                    checkManagerStatus();
                    checkTodaysData();
                } else {
                    log('‚ùå UnifiedEmployeeManager not found', 'error');
                }
            }, 1000);
        });
    </script>
</body>
</html>
